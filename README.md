# Cellpose Batch Processing

This Jupyter Notebook provides a script for batch processing microscopy images using the Cellpose library. Cellpose is a deep learning-based segmentation tool that can accurately detect and segment cells in microscopy images.

ImageJ scripts are also provided to pre-process and/or post-process the segmentation images generated by Cellpose.

## Requirements

- Python 3.x
- Cellpose library
- Pillow (PIL)
- glob
- shutil
- time

## Setup

1. Install the required libraries by running:

```
pip install cellpose pillow
```

2. Set the input directory (`inputDir`) to the folder containing your microscopy images in TIFF format.

3. Configure the model settings:
   - Choose the model type (`modelChoice`) from the available options: `"nuclei"` or `"cyto2"`.
   - Set `customModel` to `True` if you want to use a custom pre-trained model. Provide the path to the custom model in `customModelPath`.
   - Set `imageSuffix` to filter the images based on a specific suffix (e.g., `"DAPI"`, `"CY5"`, or `"Any"`).

4. Adjust the segmentation settings:
   - Set `cellDiameter` to the expected diameter of the cells in pixels. If set to `None`, the diameter will be automatically estimated.
   - Set `cellFlowThreshold` to adjust the threshold for cell probability. Increase this value if you expect more regions of interest (ROIs).
   - Set `cellProbabilityThreshold` to adjust the threshold for cell probability. Increase this value if Cellpose is returning too many ROIs, particularly from dim areas.
   - Set the `channels` parameter based on your image channels. Use `[0, 0]` for grayscale images, `[2, 3]` for G=cytoplasm and B=nucleus, or `[2, 1]` for G=cytoplasm and R=nucleus.

## Usage

1. Run the notebook cells in sequential order.

2. The script will process all TIFF images in the specified input directory.

3. The segmentation results will be saved in the same directory as the input images, with the following outputs:
   - Segmentation masks in PNG format.
   - Outlines of the segmented cells overlaid on the original images in PNG format.
   - A text file (`Cellpose_Parameters.txt`) containing the parameters used for the Cellpose segmentation.

4. The script will open the output directory once the segmentation is complete.

## Notes

- The script will automatically remove any non-TIFF files from the output directory.
- If the input images have a large number of pixels, a warning message will be displayed, suggesting to resize the images for faster processing. This can be safely ignored.
- The script utilizes GPU acceleration if available.

For more information about Cellpose and its functionalities, please refer to the official Cellpose documentation: https://cellpose.readthedocs.io/